"use strict";(self.webpackChunk_dev_web=self.webpackChunk_dev_web||[]).push([[163],{163:(e,t,n)=>{n.r(t),n.d(t,{default:()=>y});var r=n(1855),o=n(6480),a=n(9654);function l({data:e}){return r.createElement(r.Fragment,null,"ErrorsDisplay",r.createElement("pre",null,JSON.stringify(e,null,2)))}function c({count:e}){return r.createElement(r.Fragment,null,"CounterDisplay",r.createElement("pre",null,JSON.stringify(e,null,2)))}function s({data:e,onPing:t,onPingAll:n}){const o=(0,r.useRef)(null),a=(0,r.useCallback)((()=>{n&&n()}),[n]),l=(0,r.useCallback)((e=>{t&&t(e.detail.id)}),[t]);return(0,r.useEffect)((()=>{const e=o?.current;return e&&(e.addEventListener("pingAll",a),e.addEventListener("ping",l)),()=>{o&&(e.removeEventListener("pingAll",a),e.removeEventListener("ping",l))}}),[a,l,o]),r.createElement("div",{ref:o},"RemotesList",r.createElement("pre",null,JSON.stringify(e,null,2)))}function u({data:e}){return r.createElement(r.Fragment,null,"ConsoleDisplay",r.createElement("pre",null,JSON.stringify(e,null,2)))}function i(){const[e,t]=(0,r.useState)([]);return{logger:console,logs:e}}const m="master-persist-counters";function d(){const{logs:e,logger:t}=i(),[n,o]=(0,r.useState)(null),[d,E]=(0,r.useState)([]),[f,p]=(0,r.useState)(null),{ready:g,api:y,peer:h,humanizeError:b}=(0,a.a)(),N=({id:e})=>{const n=function(){try{return JSON.parse(sessionStorage.getItem(m))}catch{return{}}}();t.log({event:"remote.connect",payload:{id:e}}),E((t=>[...t,{counter:n?.[e]??0,peerId:e}]))},v=({id:e})=>{t.log({event:"remote.disconnect",payload:{id:e}}),E((t=>t.filter((({peerId:t})=>t!==e))))},S=({id:e},n)=>{t.log({event:"data",data:n,id:e}),E((t=>{const r=function(e,{data:t,id:n}){return e.reduce(((e,r)=>{if(r.peerId===n)switch(t.type){case"COUNTER_INCREMENT":e.push({...r,counter:r.counter+1});break;case"COUNTER_DECREMENT":e.push({...r,counter:r.counter-1});break;case"REMOTE_SET_NAME":e.push({...r,name:t.name});break;default:e.push(r)}else e.push(r);return e}),[])}(t,{data:n,id:e});return function(e){let t;try{t=JSON.stringify(e.reduce(((e,t)=>(e[t.peerId]=t.counter,e)),{}))}catch{t=JSON.stringify({})}sessionStorage.setItem(m,t)}(r),r}))},C=e=>{o(null),t.error({event:"error",error:e}),p([b(e)])};return(0,r.useEffect)((()=>(h&&h.on("error",C),()=>{h&&h.off("error",C)})),[h]),(0,r.useEffect)((()=>(g&&(o(h.id),t.log({event:"open",comment:"Master connected",payload:{id:h.id}}),y.on("remote.connect",N),y.on("remote.disconnect",v),y.on("data",S)),()=>{console.log("Master.jsx.cleanup"),g&&(y.off("remote.connect",N),y.off("remote.disconnect",v),y.off("data",S))})),[g]),r.createElement(r.Fragment,null,r.createElement(l,{data:f}),n&&r.createElement("div",null,r.createElement("a",{href:`${location.href}:${n}`,target:"_blank",rel:"noopener noreferrer"},n)),r.createElement("div",null,"Global counter: ",r.createElement(c,{count:(R=d,R.reduce(((e,{counter:t})=>t+e),0))})),r.createElement(s,{data:d,onPingAll:()=>{},onPing:e=>{}}),r.createElement(u,{data:[...e].reverse()}));var R}function E({onIncrement:e,onDecrement:t,disabled:n}){return r.createElement("div",{className:"counter-control"},r.createElement("button",{type:"button",className:"counter-control-add",onClick:()=>e(),style:{marginRight:"2px"},disabled:n},"+"),r.createElement("button",{type:"button",className:"counter-control-sub",onClick:()=>t(),style:{marginLeft:"2px"},disabled:n},"-"))}function f({onChangeName:e,onConfirmName:t,name:n,disabled:o}){return r.createElement("form",{className:"form-set-name",action:".",onSubmit:e=>{e.preventDefault(),t(e.target.name.value)}},r.createElement("label",null,r.createElement("input",{type:"text",placeholder:"Enter name",onChange:t=>e(t.target.value),value:n,disabled:o}),r.createElement("button",{type:"submit",disabled:o},"OK")))}function p(){const{logs:e,logger:t}=i(),[n,o]=(0,r.useState)(null),[c,s]=function(e,t){const[n,o]=(0,r.useState)((()=>{if("undefined"==typeof window)return"";try{const t=window.sessionStorage.getItem(e);return t?JSON.parse(t):""}catch(e){return console.log(e),""}}));return[n,t=>{try{const r=t instanceof Function?t(n):t;o(r),"undefined"!=typeof window&&window.sessionStorage.setItem(e,JSON.stringify(r))}catch(e){console.log(e)}}]}("remote-name"),[m,d]=(0,r.useState)(null),{ready:p,api:g,peer:y,humanizeError:h}=(0,a.a)(),b=e=>{t.log({event:"remote.disconnect",payload:e})},N=e=>{t.log({event:"remote.reconnect",payload:e}),c&&g.send({type:"REMOTE_SET_NAME",name:c})},v=e=>{o(null),t.error({event:"error",error:e}),d([h(e)])},S=(e,n)=>{t.log({event:"data",data:n})};return(0,r.useEffect)((()=>(y&&y.on("error",v),()=>{y&&y.off("error",v)})),[y]),(0,r.useEffect)((()=>(p&&(o(y.id),t.log({event:"open",comment:"Remote connected",payload:{id:y.id}}),g.on("remote.disconnect",b),g.on("remote.reconnect",N),g.on("data",S),c&&g.send({type:"REMOTE_SET_NAME",name:c})),()=>{console.log("Remote.jsx.cleanup"),p&&(g.off("remote.disconnect",b),g.off("remote.reconnect",N),g.off("data",S))})),[p]),r.createElement(r.Fragment,null,r.createElement(l,{data:m}),r.createElement(E,{onIncrement:function(){p&&g.send({type:"COUNTER_INCREMENT"})},onDecrement:function(){p&&g.send({type:"COUNTER_DECREMENT"})},disabled:!n}),r.createElement(f,{onChangeName:function(e){s(e)},name:c,onConfirmName:function(){p&&g.send({type:"REMOTE_SET_NAME",name:c})},disabled:!n}),r.createElement("p",null,"Check the counter updating in real-time on the original page, thanks to WebRTC."),r.createElement(u,{data:[...e].reverse()}))}const g=!0;function y(){const[,e=null]=(0,r.useMemo)((()=>decodeURI(location.hash).match(/^#[^:]+:(.+)?/)||[]),[]),t=(0,r.useMemo)((()=>e?"remote":"master"),[e]);return console.log({masterPeerId:e,mode:t}),r.createElement("section",null,r.createElement("h2",null,"WebRtc"),t&&r.createElement(a.y,{mode:t,init:({getPeerId:e})=>new o.Ay(e(),g?{host:"localhost",port:9e3,path:"/myapp"}:{host:"0.peerjs.com",port:443,path:"/"}),masterPeerId:e,sessionStorageKey:"webrtc-remote-control-peer-id-react"},"remote"===t?r.createElement(p,null):r.createElement(d,null)))}}}]);
//# sourceMappingURL=163.js.map